<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>~환생대기실~ The Waiting room (clean)</title>
  <style>
    /* =====================================================
       0) 전역 변수: 에셋 · 스테이지 · 사이즈 · 타이포 · 배치
       ===================================================== */
    :root{
      /* — 에셋 경로 — */
      --lobby-bg: url('bg.png');
      --dialogue-img: url('panel.png'); /* 대화창 피부 */

      /* — 고정 스테이지(1920×1080) — */
      --base-w: 1920;  /* px */
      --base-h: 1080;  /* px */
      --ui-scale: 1;   /* JS가 계산해서 주입 */

      /* — UI 확대 (원하면 값만 바꾸면 됨) — */
      --font-zoom:     1.75;  /* 글자 */
      --dlg-zoom:      1.10;  /* 대화창/패널 폭 스케일 */
      --toolbar-zoom:  1.10;  /* 상단 도구바 스케일 */
      --portrait-zoom: 1.10;  /* 초상화 스케일 */

      /* — 대화창 판 크기(견출지 자리를 그대로 사용) — */
      --dlg-w: 1100px;        /* 가로폭 */
      --dlg-h: 340px;         /* 세로높이 */
      --dlg-bg-size: contain; /* contain/cover/100% 100% */
      --dlg-wrap-bottom: 48px;/* 화면 아래에서 띄우는 거리 */

      /* — 대화 텍스트 위치 — */
      --dlg-text-x: 0px;      /* +우 / -좌 */
      --dlg-text-y: -120px;   /* +하 / -상 */
      --dlg-text-w: 78%;
      --dlg-text-align: center;
      --dlg-line-height: 1.75;

      /* — 화자 라벨(텍스트만) — */
      --speaker-gap: 10px;  /* 대화창 윗부분과 간격 */
      --speaker-font: 36px; /* 이름 폰트 사이즈 */

      /* — 색 — */
      --fg:#e7eef0; --muted:#9aa1a7; --line:#1f2429; --accent:#9feccf;
    }

    /* =====================================================
       1) 리셋 · 폰트
       ===================================================== */
    *{box-sizing:border-box}
    html, body{ height:100%; margin:0; background:#000; color:var(--fg); overflow:hidden; }

    @font-face {
      font-family: 'MissedSimsim';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2511-1@1.0/Griun_Simsimche-Rg.woff2') format('woff2');
      font-weight: 400; font-style: normal; font-display: swap;
    }
    body{ font-family:'MissedSimsim', "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* =====================================================
       2) 스테이지 스케일러(#fit-root)
       ===================================================== */
    #fit-root{
      position: fixed; left:50%; top:50%;
      width: calc(var(--base-w) * 1px);
      height: calc(var(--base-h) * 1px);
      transform: translate(-50%, -50%) scale(var(--ui-scale));
      transform-origin: 50% 50%;
      overflow:hidden; background:#000;
    }

    /* =====================================================
       3) 로비 화면
       ===================================================== */
    .lobby-screen{ position:absolute; inset:0; display:none; }
    .lobby-screen.active{ display:block; }
    .lobby-screen::before{ content:""; position:absolute; inset:0; background: var(--lobby-bg) center/cover no-repeat; }

    /* 캐릭터 선택 핫스팟 (버튼은 작게, 이미지는 크게 노출) */
    .hotspot{ position:absolute; border:none; background:transparent; cursor:pointer; overflow:visible; }
    .hotspot::before{
      content:""; position:absolute; left:50%; bottom:0; width:190%; height:190%;
      transform: translateX(-50%) scale(1.3); transform-origin:center bottom;
      background: inherit; background-size:contain; background-repeat:no-repeat; background-position:center bottom;
      pointer-events:none;
    }
    /* 각 핫스팟에 임시 PNG 연결 (원하는 파일명으로 교체) */
    .hotspot[data-id="yeon"]{ background: url('yeontag.png') center/contain no-repeat; }
    .hotspot[data-id="min"] { background: url('jaetag.png')  center/contain no-repeat; }
    .hotspot[data-id="ha"]  { background: url('hatag.png')   center/contain no-repeat; }
    .hotspot[data-id="bin"] { background: url('bintag.png')  center/contain no-repeat; }
    .visually-hidden{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

    /* =====================================================
       4) 캔버스(인트로 슬라이드 전용)
       ===================================================== */
    .canvas{ position:absolute; inset:auto; display:none; }
    .canvas.intro-mode{ display:grid; place-items:center; left:50%; top:50%; transform:translate(-50%,-50%);
      width:1280px; height:720px; background:#0b0e12; border:1px solid #0f1419; border-radius:14px; overflow:hidden; }
    .screen{ position:absolute; inset:0; display:none; }
    .screen.active{ display:block; }

    .slides{ display:grid; grid-template-rows:1fr auto; place-items:center; height:100%; padding:28px; }
    .slide-card{ width:80%; max-width:960px; min-height:360px; border:1px solid var(--line); border-radius:14px; background:#0e1217; display:grid; place-items:center; padding:32px; text-align:center }
    .slide-title{ font-weight:800; letter-spacing:.2px; margin-bottom:10px }
    .slide-body{ color:var(--muted) }
    .slide-controls{ display:flex; gap:8px; justify-content:center; margin-top:16px }
    .btn{ background:#121821; border:1px solid #24303a; color:#dfe9ec; border-radius:10px; padding:.6rem 1rem; cursor:pointer }
    .btn:hover{ border-color:#3a4b57 }

    /* =====================================================
       5) HUD(상단 도구/대화/패널) – 로비 위에 떠 있는 레이어
       ===================================================== */
    .hud{ position:absolute; inset:0; display:none; pointer-events:none; font-size: calc(18px * var(--font-zoom)); }
    .hud.active{ display:block; }

    .hud-actionbar{
      position:absolute; top:24px; left:50%; transform:translateX(-50%) scale(var(--toolbar-zoom)); transform-origin:center top;
      display:flex; gap:8px; align-items:center; pointer-events:auto;
      background: var(--dialogue-img) center/100% 100% no-repeat; border:none; border-radius:0; box-shadow:none; color:#111;
      padding:8px 10px;
    }

    .pill, .btn, .tag, .badge{
      background: var(--dialogue-img) center/100% 100% no-repeat; border:none; border-radius:0; box-shadow:none; color:#111;
      padding:.45rem .9rem; cursor:pointer; font-size:1em;
    }
    .pill.active{ outline:1px solid var(--accent); color:#111; }

    .hud-portrait{
      position:absolute; left:50%; top:120px; transform:translateX(-50%) scale(var(--portrait-zoom)); transform-origin:center top;
      max-width:520px; height:auto; filter:drop-shadow(0 10px 30px rgba(0,0,0,.5)); pointer-events:none; z-index:2;
    }

    /* 패널(생사부/기억/증거) */
    .panel{
      position:absolute; left:50%; bottom: calc(var(--dlg-wrap-bottom) + var(--dlg-h));
      transform: translateX(-50%) scale(var(--dlg-zoom)); transform-origin:center bottom;
      width: calc(min(var(--dlg-w), 90vw) * var(--dlg-zoom));
      background: var(--dialogue-img) center/100% 100% no-repeat; border:none; border-radius:0; box-shadow:none; color:#111;
      padding:12px; display:none; pointer-events:auto; z-index:3;
    }
    .panel.active{ display:block; }
    .panel h3{ margin:0 0 8px; font-size:1em; font-weight:800; color:#111; }
    .kv{ display:grid; grid-template-columns:120px 1fr; gap:8px 10px; font-size:1em; }
    .badges{ display:flex; flex-wrap:wrap; gap:8px }

    /* 대화창 래퍼(아래 중앙) */
    .dialogue-wrap{ position:absolute; left:50%; bottom: var(--dlg-wrap-bottom); transform:translateX(-50%);
      width: calc(var(--dlg-w) * var(--dlg-zoom)); pointer-events:auto; z-index:5; }

    /* 대화창 박스(견출지 자리 = 이미지)
       ※ aspect-ratio 제거하고 높이를 고정해서 이미지가 칸에 딱 맞게 */
    .dialogue{ width:100%; height:var(--dlg-h); background: var(--dialogue-img) center/ var(--dlg-bg-size) no-repeat;
      border:none; display:flex; flex-direction:column; justify-content:flex-end; padding:18px 24px; }

    /* 이름 바는 숨김(위에 스피커 라벨로 대체) */
    #hud .dialogue .namebar, #screen-case .dialogue .namebar{ display:none; }

    /* 대화 텍스트 위치/너비 컨트롤(전역 변수로 조절) */
    #hud .dialogue .text, #screen-case .dialogue .text{
      position:relative; transform:translate(var(--dlg-text-x), var(--dlg-text-y));
      width:var(--dlg-text-w); margin:0 auto; text-align:var(--dlg-text-align); line-height:var(--dlg-line-height);
      color:#111;
    }

    /* 화자 라벨(텍스트만) – 대화창 위 중앙 */
    .speaker-chip{
      position:absolute; left:50%; top: calc(var(--dlg-wrap-bottom) + var(--speaker-gap));
      transform: translate(-50%, -100%); /* 대화창 바로 위에 */
      z-index:6; background:transparent; border:none; padding:0; color:#fff; font-weight:800; font-size:var(--speaker-font);
      line-height:1; white-space:nowrap; letter-spacing:.02em;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
    }

    /* ===== 구 케이스 레이아웃(도킹 UI) – 필요 최소만 유지 ===== */
    .case{ display:grid; grid-template-rows:auto 1fr auto; height:100% }
    .actionbar{ display:flex; gap:8px; justify-content:center; align-items:center; padding:8px; background:transparent; }
    .stage{ position:relative; display:grid; place-items:center }
    .portrait{ max-width:380px; max-height:46vh; object-fit:contain; filter:drop-shadow(0 10px 30px rgba(0,0,0,.5)) }
    .nextbar{ display:flex; justify-content:center; align-items:center; padding:6px 0 }

    /* === NEXT 버튼(이미지 없음, 자유 위치) === */
:root{
  /* 위치 조절용 변수 */
  --next-left: 50%;     /* px/% 모두 OK */
  --next-bottom: 48px;  /* px 권장 */
  --next-tx: -50%;      /* 가운데 정렬 */

  /* 타이포/간격 */
  --next-font: 20px;
  --next-weight: 700;
  --next-letter: 0.2px;
  --next-padding-x: 8px;
  --next-padding-y: 6px;
}

/* 전역 NEXT 버튼 기본 스타일(텍스트만) */
#next-btn{
  position: absolute;
  left: var(--next-left);
  bottom: var(--next-bottom);
  transform: translateX(var(--next-tx));
  z-index: 10;
  pointer-events: auto;

  background: none;
  border: none;
  color: #fff;
  font-size: var(--next-font);
  font-weight: var(--next-weight);
  letter-spacing: var(--next-letter);
  padding: var(--next-padding-y) var(--next-padding-x);
  cursor: pointer;
  user-select: none;
}

/* 기존 nextbar(대화창 안) 전부 숨김 */
.nextbar{ display: none !important; }

/* ===== 챕터 오버레이 ===== */
#cutscene{
  position:absolute; inset:0;
  display:none;
  opacity:0;
  transition: opacity .35s ease;
  z-index: 999;
  background: rgba(0,0,0,.94);
  place-items: center;
}
#cutscene.visible{ display:grid; opacity:1; }

#cutscene .cutscene-inner{ text-align:center; max-width:70%; }
#cutscene #cutscene-title{
  font-weight: 800;
  letter-spacing: .04em;
  font-size: clamp(28px, 3.8vw, 72px);
  color:#fff;
}
#cutscene #cutscene-sub{
  margin-top:.35em;
  font-size: clamp(14px, 1.6vw, 26px);
  opacity:.8;
  color:#d0d0d0;
}
#cutscene #cutscene-hint{
  margin-top:1.1em;
  font-size: clamp(12px, 1.2vw, 18px);
  opacity:.55;
  color:#c0c0c0;
}

  </style>
</head>
<body>
  <div id="fit-root">
    <!-- ========================= LOBBY ========================= -->
    <section id="screen-lobby" class="lobby-screen active">
      <button class="hotspot" data-id="yeon" style="left:16%; bottom:18%; width:12%; height:28%">
        <span class="visually-hidden">연 선택</span>
      </button>
      <button class="hotspot" data-id="min" style="left:36%; bottom:22%; width:12%; height:26%">
        <span class="visually-hidden">민 선택</span>
      </button>
      <button class="hotspot" data-id="ha" style="left:56%; bottom:20%; width:12%; height:28%">
        <span class="visually-hidden">하 선택</span>
      </button>
      <button class="hotspot" data-id="bin" style="left:76%; bottom:19%; width:12%; height:30%">
        <span class="visually-hidden">빈 선택</span>
      </button>
    </section>

    <!-- ========================= HUD (로비 위에 떠 있음) ========================= -->
    <section id="hud" class="hud">
      <div class="hud-actionbar" id="hud-actionbar">
        <button class="pill" data-panel="ledger">생사부</button>
        <button class="pill" data-panel="memory">기억</button>
        <button class="pill" data-panel="evidence">증거</button>
        <button class="pill" data-panel="dialogue">대화</button>
        <span style="margin-left:auto"></span>
        <button class="pill" id="hud-exit">↩ 로비</button>
      </div>

      <img id="hud-portrait" class="hud-portrait" alt="portrait" />

      <div id="hud-panel-ledger" class="panel"><h3>생사부</h3><div id="hud-kv" class="kv"></div></div>
      <div id="hud-panel-memory" class="panel"><h3>기억</h3><div id="hud-mem" class="badges"></div></div>
      <div id="hud-panel-evidence" class="panel"><h3>증거</h3><div id="hud-evd" class="badges"></div></div>

      <div class="dialogue-wrap">
        <div id="speaker-chip" class="speaker-chip" aria-live="polite"></div>
        <div class="dialogue">
          <div class="namebar"><span id="hud-name" class="tag">망자</span><span id="hud-role" style="opacity:.7"></span></div>
          <div id="hud-text" class="text"></div>
        </div>
      </div>
    </section>

    <!-- 자유 위치 NEXT 버튼(텍스트) -->
    <button id="next-btn" type="button" aria-label="다음">스페이스 바를 눌러 진행</button>

    <!-- ▼ 챕터 오버레이 -->
    <div id="cutscene" aria-hidden="true">
      <div class="cutscene-inner">
        <div id="cutscene-title">CHAPTER</div>
        <div id="cutscene-sub"></div>
        <div id="cutscene-hint">계속하려면 아무 키나 누르세요</div>
      </div>
    </div>

    <!-- ========================= CANVAS (인트로) ========================= -->
    <main id="canvas" class="canvas intro-mode" aria-label="game-canvas">
      <section id="screen-intro" class="screen active" aria-label="intro">
        <div class="slides">
          <div class="slide-card">
            <div>
              <div class="slide-title" id="slide-title">천국 · 지옥 · 그리고 중간계</div>
              <div class="slide-body" id="slide-body">문턱에 머문 자들의 말을 듣고, 남은 증거를 정리해 길을 엽니다.</div>
              <div class="slide-controls">
                <button class="btn" id="btn-next">다음</button>
                <button class="btn" id="btn-skip">바로 시작</button>
              </div>
              <div style="margin-top:8px;color:#6b7680;font-size:12px">(클릭/Space/Enter로도 넘김)</div>
            </div>
          </div>
          <div style="height:42px"></div>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* =====================================================
       A) 스케일러
       ===================================================== */
    const BASE_W = 1920, BASE_H = 1080;
    function applyScale(){
      const vw = (window.visualViewport?.width  ?? window.innerWidth);
      const vh = (window.visualViewport?.height ?? window.innerHeight);
      const s  = Math.min(vw / BASE_W, vh / BASE_H);
      document.documentElement.style.setProperty('--ui-scale', s);
    }
    addEventListener('resize', applyScale);
    addEventListener('orientationchange', applyScale);
    applyScale();

    /* =====================================================
       B) 콘텐츠 데이터(여기에만 내용 채우면 됨)
       ===================================================== */
    const SLIDES=[
      {t:'반갑습니다. 기다리고 있었습니다.', b:'이 곳은 다름아닌 "저승". 그 중에서도... 천국도 지옥도 아닌, "중간계"입니다.'},
      {t:'당신은 특별한 존재입니다.', b:'그래요. 당신의 정체는 바로 "환생 설득자". 이 중간계의 혼들을 달래, 모두 환생시키는 것이 당신의 일입니다.'},
      {t:'당신에게는 어려운 일이 아닙니다.', b:'로비의 혼령들을 클릭해 이야기를 들어주십시오.'},
      {t:'그럼, 행운을 빌죠.', b:'당신을 로비로 전송하겠습니다.'}
    ];

    const CHARACTERS = [
      { id:'yeon', name:'호연', role:'웨딩플래너',
        sprites:{ neutral:'yeon.png', sad:'yeon.png', smile:'yeon.png' },
        ledger:{ 장소:'과기역 4번 출구', 소지품:'의문의 노트, 일기장', 시각:'4:44' },
        memories:['체크리스트의 기억','그날의 사고'],
        evidence:['CCTV 영상','목격자 망자'],
        lines:[
          '호연 : 나 때문이야…',
          '나 : 원한이 있나?',
          '호연 : 원한? 원한이라고 할 수 있는건가..',
          '호연 : 내 "죄"에 대한 원한이야.',
          '나 : 너의... "죄"?',
          '호연 : 그래. 난 중간계가 아니라 지옥으로 갔어야 해.',
          '나 : 저승은 실수하지 않아. 네 죄가 뭔데?',
          '호연 : ...',
          '나 : ...',
          '호연 : ... 살인.',
          '[CHAPTER: 챕터 1. 그날의 기억 | 호연]',
          '나 : "살인"... 이라고.',
          '호연 : 맞아. 물론 그들이 죽길 바랐던건 아니야.',
          '호연 : 난, 난 그저...'
        ]
      },
      { id:'min', name:'재갑', role:'탐사 기자',
        sprites:{ neutral:'reporter.png', think:'reporter.png', shock:'reporter.png' },
        ledger:{ 장소:'폐건물 1층 출입문', 소지품:'녹음기·출입카드·수첩', 시각:'4:44' },
        memories:['관리자 경고 무시','문 오버라이드','녹음기 4:44에서 단절'],
        evidence:['출입 통제 로그','경고 음성/문자','녹음기 복구'],
        lines:[ 
          '재갑 : 뭐였을까... 대체', 
          '나 : 당신은 또 무슨 일이야?',
          '재갑 : 당신, 저승사자인가?',
          '나 : 그런셈이지.',
          '재갑 : 잘됐군. 물어보고 싶은게 있는데.',
          '나 : 잠깐, 그 궁금증만 해결되면 바로 환생할 생각인거겠지?',
          '재갑 : '
        ]
      },
      { id:'ha', name:'원하', role:'응급의학과 의사',
        sprites:{ neutral:'doc.png', tired:'doc.png', relief:'doc.png' },
        ledger:{ 장소:'병원 자동문 앞', 소지품:'깨진 청진기·호출기·DNR', 시각:'—' },
        memories:['동시 3케이스','자동문 앞 멈칫','아이 휠체어 우선'],
        evidence:['ER 근무일지','DNR 원본','동료 진술/호출 로그'],
        lines:[ '원하 : 손을 놓으면... 환자는..', '나 :' ]
      },
      { id:'bin', name:'한빈', role:'철학 대학원',
        sprites:{ neutral:'phil.png', argue:'phil.png', calm:'phil.png' },
        ledger:{ 장소:'옥상 출입문 문턱', 소지품:'논문 초고·각주 카드·안경', 시각:'—' },
        memories:['정체성은 환상(발표)','문고리 확인(왼손)','정지=존속 메모'],
        evidence:['인용 원문 카드','습관 로그','테세우스의 배 카드'],
        lines:[ '한빈 : 불교 교리에서 최고의 길은 윤회 고리를 끊는 것이야.', '한빈 : 여기서 멈추는 게 열반에 가깝지.' ]
      }
    ];

    /* =====================================================
       C) 상태/유틸
       ===================================================== */
    const screens={ intro:qs('#screen-intro'), lobby:qs('#screen-lobby') };
    const canvasEl=qs('#canvas');
    let state={ screen:'intro', slideIndex:0, cur:null, lineIndex:0, panel:'dialogue' };

    function qs(s,root=document){ return root.querySelector(s); }
    function setCanvasMode(mode){
      canvasEl.style.display='none';
      canvasEl.classList.remove('intro-mode');
      if(mode==='intro'){ canvasEl.style.display='grid'; canvasEl.classList.add('intro-mode'); }
    }
    function showHUD(on){ hud.style.display = on? 'block':'none'; hud.classList.toggle('active', !!on); }

    /* =====================================================
       D) 화면 전환
       ===================================================== */
    function showIntro(){
      screens.lobby.classList.remove('active');
      setCanvasMode('intro');
      swapScreen('intro');
      showHUD(false);
      updateNextBtn();
    }
    function goLobby(){
      setCanvasMode('hidden');
      screens.lobby.classList.add('active');
      swapScreen(null);
      state.screen='lobby';
      showHUD(false);
      updateNextBtn();
    }
    function swapScreen(key){
      qs('#screen-intro')?.classList.remove('active');
      if(key==='intro') qs('#screen-intro')?.classList.add('active');
      state.screen = key || state.screen;
    }

    /* =====================================================
       E) 인트로 슬라이드
       ===================================================== */
    const slideTitle=qs('#slide-title');
    const slideBody =qs('#slide-body');
    const btnNext   =qs('#btn-next');
    const btnSkip   =qs('#btn-skip');

    function renderSlide(){
      const s=SLIDES[state.slideIndex];
      slideTitle.textContent=s.t; slideBody.textContent=s.b;
      btnNext.textContent = (state.slideIndex===SLIDES.length-1)? '로비로':'다음';
    }
    function nextSlide(){
      if(state.slideIndex<SLIDES.length-1){ state.slideIndex++; renderSlide(); }
      else { goLobby(); }
    }
    btnNext.addEventListener('click', nextSlide);
    btnSkip.addEventListener('click', goLobby);
    screens.intro.addEventListener('click', e=>{ if(!e.target.closest('.btn')) nextSlide(); });

    /* =====================================================
       F) 로비 → 케이스 오픈(HUD)
       ===================================================== */
    screens.lobby.addEventListener('click', (e)=>{
      const hs=e.target.closest('.hotspot'); if(!hs) return; openCase(hs.dataset.id);
    });

    const hud=qs('#hud');
    const hudActionbar = qs('#hud-actionbar');
    const hudPortrait  = qs('#hud-portrait');
    const hudKV  = qs('#hud-kv');
    const hudMEM = qs('#hud-mem');
    const hudEVD = qs('#hud-evd');
    const hudText= qs('#hud-text');

    function openCase(id){
      setCanvasMode('hidden'); screens.lobby.classList.add('active'); swapScreen(null);
      state.cur = CHARACTERS.find(c=>c.id===id);
      state.lineIndex=0; state.panel='dialogue'; state.screen='case';
      setPose('neutral');
      // 패널 채우기
      hudKV.innerHTML  = Object.entries(state.cur.ledger).map(([k,v])=>`<div>${k}</div><div>${v}</div>`).join('');
      hudMEM.innerHTML = state.cur.memories.map(x=>`<span class='badge'>${x}</span>`).join('');
      hudEVD.innerHTML = state.cur.evidence.map(x=>`<span class='badge'>${x}</span>`).join('');
      showHUD(true); showPanel('dialogue'); say(state.cur.lines[0]||'');
      updateNextBtn();
    }
    function setPose(pose='neutral'){
      if(!state.cur) return;
      const sp = state.cur.sprites?.[pose] || state.cur.sprites?.neutral;
      if(sp) hudPortrait.src = sp;
    }

    /* =====================================================
       G) 대화/패널/키조작
       ===================================================== */
    function showPanel(key){
      state.panel=key;
      ['ledger','memory','evidence'].forEach(id=>{
        qs('#hud-panel-'+id).classList.toggle('active', id===key);
      });
      [...hudActionbar.querySelectorAll('.pill[data-panel]')].forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.panel===key);
      });
    }

    const STRIP_SPEAKER_PREFIX = true; // "이름 : 내용"에서 이름은 위 라벨로, 본문엔 내용만
    function parseSpeakerLine(raw){
      const m = /^\s*([^:：]+)\s*[:：]\s*(.*)$/.exec(raw || "");
      if(!m){
        return { who: (state.cur?.name || ""), text: raw || "" };
      }
      let who = (m[1] || "").trim();
      let text = (m[2] || "").trim();
      const alias = { "나":"나", "주인":"나" };
      if(alias[who]) who=alias[who];
      return { who, text: STRIP_SPEAKER_PREFIX ? text : `${who}: ${text}` };
    }

    // [CHAPTER: 제목 | 부제] 형태 감지
    function parseCutsceneToken(s){
      const m = /^\s*\[(?:CHAPTER|CUTSCENE)\s*:\s*([^|\]]+?)(?:\|([^|\]]+))?\]\s*$/i.exec(s || "");
      if(!m) return null;
      return { title: (m[1]||"").trim(), subtitle: (m[2]||"").trim() };
    }

    function updateSpeakerLabel(who){ qs('#speaker-chip').textContent = who || ""; }
    function say(line){ const { who, text } = parseSpeakerLine(line); updateSpeakerLabel(who); hudText.textContent = text; }

    function nextLine(){
      const lines = state.cur?.lines || [];
      if(!lines.length) return;

      // 다음 줄
      state.lineIndex = Math.min(state.lineIndex + 1, lines.length - 1);
      const raw = lines[state.lineIndex] || "";

      // 1) 챕터 토큰이면 오버레이
      const cut = parseCutsceneToken(raw);
      if(cut){
        showChapter(cut.title, cut.subtitle, { clickToClose:true });
        return; // 이 줄은 화면에 쓰지 않음 → 오버레이 닫힌 뒤 입력 한 번 더로 다음 대사 진행
      }

      // 2) 일반 대사
      say(raw);

      // (선택) 포즈 스크립트
      const poseScript = { yeon:{1:'sad',2:'smile'}, min:{1:'think',2:'shock'}, ha:{1:'tired',2:'relief'}, bin:{1:'argue',2:'calm'} };
      const map = poseScript[state.cur.id];
      if(map && map[state.lineIndex]) setPose(map[state.lineIndex]);
    }

    // 자유 위치 NEXT 버튼
    const nextBtn = document.getElementById('next-btn');
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        showPanel('dialogue');
        nextLine();
      });
    }

    function updateNextBtn() {
      if (!nextBtn) return;
      const visible = (state.screen === 'case' || hud.classList.contains('active'));
      nextBtn.style.display = visible ? 'block' : 'none';
    }

    // 단축키
    addEventListener('keydown', (e)=>{
      if(state.screen==='intro'){ if(e.key===' '||e.key==='Enter'){ nextSlide(); } return; }
      if(state.screen!=='case') return;
      if(e.key==='1') showPanel('ledger');
      if(e.key==='2') showPanel('memory');
      if(e.key==='3') showPanel('evidence');
      if(e.key==='4'){ showPanel('dialogue'); nextLine(); }
      if(e.key===' '||e.key==='Enter'){ e.preventDefault(); showPanel('dialogue'); nextLine(); }
    });

    /* 시작 */
    function renderSlideInit(){ renderSlide(); }
    renderSlideInit();
    showIntro();

    // ==== 입력 잠금 (오버레이 동안 키/버튼 무시) ====
    window.__inputLocked = false;
    function lockInput(on){
      window.__inputLocked = !!on;
      const btns = [ document.getElementById('next-btn') ];
      btns.forEach(b=>{
        if(!b) return;
        b.disabled = on;
        b.style.pointerEvents = on ? 'none':'auto';
        b.style.opacity = on ? .6 : '';
      });
    }
    // 잠금 시 키 이벤트 삼키기(캡처)
    window.addEventListener('keydown', (e)=>{
      if(window.__inputLocked){ e.preventDefault(); e.stopImmediatePropagation(); }
    }, true);

    // ==== 챕터 오버레이 ====
    const cutscene = (()=>{
      const el   = document.getElementById('cutscene');
      const t    = document.getElementById('cutscene-title');
      const sub  = document.getElementById('cutscene-sub');
      const hint = document.getElementById('cutscene-hint');

      const sleep = ms => new Promise(r=>setTimeout(r, ms));
      const waitAnyKeyOrClick = () => new Promise(res=>{
        const done = () => { window.removeEventListener('keydown',done,true); el.removeEventListener('click',done); res(); };
        window.addEventListener('keydown',done,true);
        el.addEventListener('click',done);
      });

      return {
        /**
         * cutscene.show({title, subtitle, hold, clickToClose, fade})
         * title/subtitle: 표시 텍스트
         * hold: 자동닫힘 대기(ms) — clickToClose=false일 때 사용
         * clickToClose: 클릭/키로 닫기 (기본 true)
         * fade: 사라질 때 페이드(ms)
         */
        async show({ title="", subtitle="", hold=1500, clickToClose=true, fade=350 } = {}){
          lockInput(true);
          t.textContent   = title;
          sub.textContent = subtitle || "";
          hint.style.display = clickToClose ? 'block' : 'none';

          el.style.display = 'grid';
          requestAnimationFrame(()=> el.classList.add('visible'));

          if(clickToClose) await waitAnyKeyOrClick();
          else             await sleep(Math.max(0, hold));

          el.classList.remove('visible');
          await sleep(fade);
          el.style.display = 'none';
          lockInput(false);
        }
      };
    })();

    // 전역에서 호출할 수 있게
    window.showChapter = (title, subtitle="", opts={}) => cutscene.show({ title, subtitle, ...opts });

  </script>
</body>
</html>
